name: Diff
on:
  issue_comment:
    types: [created]

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      diffs: ${{ steps.regress-ci.outputs.diffs }}
    if: ${{ github.event.issue.pull_request }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - run: cargo regress ci
        id: regress-ci
        env:
          GITHUB_COMMENT: ${{ github.event.comment.body }}
          GITHUB_COMMENT_PR: ${{ github.event.comment.issue_url }}
  diff:
    runs-on: ubuntu-latest
    needs: [generate]
    if: needs.generate.outputs.diffs != '{}' && needs.generate.outputs.diffs != '[]' && needs.generate.outputs.diffs != ''
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate.outputs.diffs) }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - uses: taiki-e/install-action@v2
        if: matrix.needs_semver_checks
        with:
          tool: cargo-semver-checks

      - run: gh repo set-default Emilgardis/svd2rust

      - run: cargo regress diff ${{ matrix.command }}
